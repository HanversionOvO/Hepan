import { CommonConstant } from 'base_common';
import { CustomMarkdown } from 'base_ui';

// å®šä¹‰å†…å®¹æŽ¥å£ï¼Œå‚è€ƒ API è¿”å›žç»“æž„
export interface ContentItem {
  type: number; // 0:æ–‡æœ¬, 1:å›¾ç‰‡, 3:éŸ³é¢‘, 4:é“¾æŽ¥, 5:é™„ä»¶
  infor: string; // æ ¸å¿ƒå†…å®¹æˆ–æ–‡ä»¶å
  url?: string; // é“¾æŽ¥æˆ–ä¸‹è½½åœ°å€
  desc?: string; // é™„ä»¶å¤§å°æè¿°ç­‰
  originalInfo?: string; // å›¾ç‰‡åŽŸå›¾åœ°å€
  aid?: number; // é™„ä»¶ID
}

@ComponentV2
export struct TieContentRender {
  @Param @Require contents: ContentItem[];
  @Param textSize: number = CommonConstant.TextSizeNormal;
  // è®¡ç®—å±žæ€§ï¼šåˆ†ç¦»æ™®é€šå†…å®¹å’Œé™„ä»¶
  @Local displayItems: ContentItem[] = [];
  @Local attachmentItems: ContentItem[] = [];

  aboutToAppear() {
    this.processContents();
  }

  @Monitor('contents')
  onContentsChange() {
    this.processContents();
  }

  private processContents() {
    if (!this.contents) {
      this.displayItems = [];
      this.attachmentItems = [];
      return;
    }
    // Type 5 ä¸ºé™„ä»¶ï¼Œæ”¾ç½®äºŽæœ«å°¾ï¼›å…¶ä»–æŒ‰é¡ºåºå±•ç¤º
    this.displayItems = this.contents.filter(item => item.type !== 5);
    this.attachmentItems = this.contents.filter(item => item.type === 5);
  }

  @Builder
  AttachmentCard(item: ContentItem) {
    Row() {
      // é™„ä»¶å›¾æ ‡
      Image($r('sys.media.ohos_app_icon')) // å»ºè®®æ›¿æ¢ä¸ºä¸“é—¨çš„æ–‡ä»¶å›¾æ ‡
        .width(40)
        .height(40)
        .objectFit(ImageFit.Contain)
        .margin({ right: CommonConstant.NormalContainerInnerPadding })

      Column({ space: 4 }) {
        Text(item.infor) // æ–‡ä»¶å
          .fontSize(CommonConstant.TextSizeNormal)
          .fontColor($r('sys.color.font_primary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(item.desc || 'æœªçŸ¥å¤§å°') // å¤§å°æè¿°
          .fontSize(CommonConstant.TextSizeSmall)
          .fontColor($r('sys.color.font_tertiary'))
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // ä¸‹è½½æŒ‰é’®
      Button('ä¸‹è½½')
        .fontSize(CommonConstant.TextSizeSmall)
        .height(28)
        .backgroundColor(CommonConstant.ThemeColor)
        .onClick(() => {
          if (item.url) {
            // TODO: å¤„ç†ä¸‹è½½é€»è¾‘ï¼Œitem.url å³ä¸ºä¸‹è½½é“¾æŽ¥
            console.info('Download:', item.url);
          }
        })
    }
    .width(CommonConstant.FullPercent)
    .padding(CommonConstant.NormalContainerInnerPadding)
    .backgroundColor($r('app.color.tetertiary_window_background'))
    .borderRadius(CommonConstant.RadiusNormal)
    .margin({ top: CommonConstant.SmallContainerInnerPadding })
  }

  @Builder
  LinkCard(item: ContentItem) {
    Row() {
      Text('ðŸ”— é“¾æŽ¥ï¼š')
        .fontSize(this.textSize)
        .fontColor($r('sys.color.font_secondary'))
      Text(item.infor) // é“¾æŽ¥æ–‡æœ¬
        .fontSize(this.textSize)
        .fontColor(CommonConstant.ThemeColor)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
    }
    .width(CommonConstant.FullPercent)
    .padding(CommonConstant.SmallContainerInnerPadding)
    .backgroundColor($r('app.color.tetertiary_window_background'))
    .borderRadius(CommonConstant.RadiusSmall)
    .onClick(() => {
      // TODO: æ‰“å¼€é“¾æŽ¥
      const targetUrl = item.url || item.infor;
      console.info('Open link:', targetUrl);
    })
  }

  build() {
    Column({ space: CommonConstant.NormalContainerInnerPadding }) {
      // 1. æ¸²æŸ“ä¸»ä½“å†…å®¹
      ForEach(this.displayItems, (item: ContentItem, index: number) => {
        if (item.type === 0) {
          // æ–‡æœ¬ï¼šä½¿ç”¨å¢žå¼ºç‰ˆ CustomMarkdown è§£æž BBCode å’Œ phiz è¡¨æƒ…
          CustomMarkdown({
            content: item.infor,
            useParallel: false, // å…³é”®ï¼šå…³é—­å¹¶è¡Œæ¨¡å¼ï¼Œä½¿ç”¨æ‰‹åŠ¨è§£æž
            textSize: this.textSize
          })
        } else if (item.type === 1) {
          // å›¾ç‰‡
          Image(item.originalInfo || item.infor)
            .width(CommonConstant.FullPercent)
            .objectFit(ImageFit.Contain)
            .borderRadius(CommonConstant.RadiusNormal)
            .backgroundColor($r('app.color.tetertiary_window_background'))
            .enableAnalyzer(true) // å¼€å¯å›¾ç‰‡åˆ†æžï¼ˆå¦‚æ–‡å­—æå–ï¼‰

        } else if (item.type === 3) {
          // éŸ³é¢‘ (å ä½)
          Row() {
            Text("ðŸŽµ éŸ³é¢‘å†…å®¹: " + item.infor).fontColor($r('sys.color.font_secondary'))
          }.width(CommonConstant.FullPercent).padding(10).backgroundColor($r('app.color.tetertiary_window_background'))

        } else if (item.type === 4) {
          // é“¾æŽ¥
          this.LinkCard(item)
        }
      })

      // 2. æ¸²æŸ“æœ«å°¾é™„ä»¶
      if (this.attachmentItems.length > 0) {
        Column() {
          Divider().margin({ top: 10, bottom: 10 })
          Text("é™„ä»¶åˆ—è¡¨")
            .fontSize(CommonConstant.TextSizeSmall)
            .fontColor($r('sys.color.font_secondary'))
            .width(CommonConstant.FullPercent)

          ForEach(this.attachmentItems, (item: ContentItem) => {
            this.AttachmentCard(item)
          })
        }
        .width(CommonConstant.FullPercent)
      }
    }
    .width(CommonConstant.FullPercent)
    .alignItems(HorizontalAlign.Start)
  }
}