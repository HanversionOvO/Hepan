# 登录

由于新版的登录接口有验证码，因此需要先在旧版登陆后获取`cookie`，再调用新版的登录接口获取`Authorization`，新版的接口都需要同时带上`Authorization`和`cookie`。

`cookie`和`Authorization`都有有效期限制，具体时间暂不知晓。如要长期运行请配置自动定时重新登录。

## 获取cookie

注意：此接口为`Discuz!`旧版接口，之所以使用是因为可以不需要验证码登录，但15分钟内最多错误5次。

<details>
    <summary>数据包</summary>

```text
POST /member.php?mod=logging&action=login&loginsubmit=yes&inajax=1 HTTP/1.1
Host: bbs.uestc.edu.cn
Content-Length: 65
Content-Type: application/x-www-form-urlencoded

loginfield=username&username=your_username&password=your_password
```

</details>
<br>

方法：`POST`

地址：`/member.php?mod=logging&action=login&loginsubmit=yes&inajax=1`

表单：

- `loginfield`: 枚举：`username`, `uid`
- `username`: 用户名或UID，需要url编码
- `password`: 密码，需要url编码

### 成功

```xml
<?xml version="1.0" encoding="utf-8"?>
<root><![CDATA[<script type="text/javascript" reload="1">if($('succeedmessage')) {$('succeedmessage').innerHTML = '';}if(typeof succeedhandle_=='function') {succeedhandle_('https://bbs.uestc.edu.cn/', '', {});}</script><script type="text/javascript">setTimeout("window.location.href ='https://bbs.uestc.edu.cn/';", 3000);$('succeedmessage_href').href = 'https://bbs.uestc.edu.cn/';$('main_message').style.display = 'none';$('main_succeed').style.display = '';$('succeedlocation').innerHTML = '欢迎您回来，鲤鱼 (Lv.7) Range6，现在将转入登录前页面';</script>]]></root>
```

`cookie`通过`Set-Cookie`头返回，之后的任何请求请附带有效`cookie`。

### 失败

```xml
<?xml version="1.0" encoding="utf-8"?>
<root><![CDATA[登录失败，您还可以尝试 4 次<script type="text/javascript" reload="1">if(typeof errorhandle_=='function') {errorhandle_('登录失败，您还可以尝试 4 次', {'loginperm':'4'});}</script>]]></root>
```

## 获取Authorization

此接口需要`cookie`。

<details>
    <summary>数据包</summary>

```text
POST /_/auth/adoptLegacyAuth HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效cookie
Content-Length: 0
X-Uestc-Bbs: 1
```

</details>
<br>

方法：`POST`

地址：`/_/auth/adoptLegacyAuth`

必带头：

- `X-Uestc-Bbs`: `1`
- `Cookie`: 有效cookie

### 成功

通过`Set-Cookie`返回一个名为`newbbs_auth`的`cookie`。

正文返回一个`json`，其中`json["data"]["authorization"]`即为需要的`Authorization`，之后的请求需要在`Authorization`头加上此值。

<details>
    <summary>原始json</summary>

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "authorization": "CpOULISDwS+HSgJdIkbw3FyTTuQL1m//t4VazxKs6qkkC+QdNI6xGr5AjgNQZEwVrOztdeIn497/+rJlEgrDou2aolafi72ZbkMTqmcaq7FHboWGgVfxRyp/sqLDxs7e/FJbhoKO1vKOpae4famT",
        "uid": 287813,
        "user_settings_version": 0,
        "user_frontend_settings": {}
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version":11,
        "client_version":1
    }
}
```

</details>
<br>

### 失败

当未携带有效`cookie`，或者`X-Uestc-Bbs`头未置`1`时，触发`403`错误。

<details>
    <summary>数据包</summary>

```html
HTTP/1.1 403 Forbidden
Server: none
Date: Sun, 07 Dec 2025 09:24:54 GMT
Content-Type: text/html
Connection: keep-alive
Content-Length: 3046

<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi">
    
    <title>访问出错 - 403</title>
</head>
<body>
<div style="box-sizing: border-box;
    font-size: 1em;
    line-height: 1.6em;
    margin: 14vh auto 0;
    max-width: 600px;
    width: 100%;
    text-align:center;
">
    <img src="./访问出错 - 403_files/wengine-auth-failed.png" alt="" style="width:200px;height:200px;">
    <div style="margin-top:40px; color:#535353; text-align:left;">
 
<div id="link-container"></div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    var currentPath = location.pathname; 
    var link = document.createElement('a');
    link.href = 'https://webvpn.uestc.edu.cn/https/77726476706e69737468656265737421f2f552d232357b447d468ca88d1b203b' + currentPath; 
    link.textContent = '点此登录';  
    link.style.fontSize = '20px'; // 设置字体大小为20px

    var textNode1 = document.createTextNode("很抱歉，由于资源路径配置错误或权限原因，网站无法访问。如您不在校园网内，请");
    var textNode2 = document.createTextNode("访问。");

    var container = document.getElementById('link-container');
    container.appendChild(textNode1);
    container.appendChild(link);
    container.appendChild(textNode2);
});
</script>
        <p id="reason"></p>
        <div style="display: block;
    font-size: .8em;margin-top: 12px;">(错误代码：403)</div>
    </div>
</div>
<script>
    function IsIPv4(ip){
        if ( /^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])\.([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])\.([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])\.([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$/g.test(ip)) {
            return true;
        }
        return false;
    }
    function IsIPv6(ip){
        if ( /^((?:[0-9A-Fa-f]{1,4}))((?::[0-9A-Fa-f]{1,4}))*::((?:[0-9A-Fa-f]{1,4}))((?::[0-9A-Fa-f]{1,4}))*|((?:[0-9A-Fa-f]{1,4}))((?::[0-9A-Fa-f]{1,4})){7}$/g.test(ip)) {
            return true;
        }
        return false;
    }
    function IsIP(ip)
    {
        if(IsIPv4(ip) || IsIPv6(ip)){
            return true;
        }
        return false;
    }
    var remote_addr = '117.173.139.74';
    var host = window.location.hostname;
    function GetErrors(){
        var errors = [];
        errors.push("您(IP："+remote_addr+")，没有权限访问相应的资源("+window.location.href+")，请通过校园网或VPN获取相应的访问权限");
        errors.push("您所访问的资源("+window.location.href+")，可能存在配置时路径错误，请联系管理员修改相关配置");
        return errors;
    }
    var e = GetErrors();
    var content = "";
    for(var i in e){
        content += "<li>"+e[i]+"</li>";
    }
    document.getElementById("reason").innerHTML = content;
</script>
</body></html>
```

</details>
<br>
