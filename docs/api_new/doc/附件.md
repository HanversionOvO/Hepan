# 附件

要使用此文档所示的接口，请先[登录](./登录.md)。

## 上传附件

> [!CAUTION]
> <span style="color:red">在任何时候，你都不应该手动构造原始的HTTP数据包，而应该让HTTP库自己构造，参见下方的[上传图片代码示例](#上传图片代码示例)和[上传其他类型文件代码示例](#上传其他类型文件代码示例)。</span>

注意：图片与其他类型文件的表现有些许差别。具体为type的值为`image`而不是`file`。

### 上传图片

<details>
    <summary>数据包</summary>

```text
POST /_/attachment/upload HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 148655
Authorization: 有效Authorization
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryLatNJXPXcpbXF0u9

------WebKitFormBoundaryLatNJXPXcpbXF0u9
Content-Disposition: form-data; name="kind"

forum
------WebKitFormBoundaryLatNJXPXcpbXF0u9
Content-Disposition: form-data; name="type"

image
------WebKitFormBoundaryLatNJXPXcpbXF0u9
Content-Disposition: form-data; name="files[]"; filename="test.jpeg"
Content-Type: image/jpeg

图片的二进制数据

------WebKitFormBoundaryLatNJXPXcpbXF0u9--
```

</details>
<br>

方法：`POST`

路径：`/_/attachment/upload`

> [!CAUTION]
> <span style="color:red">再次警告：在任何时候，你都不应该手动构造原始的HTTP数据包，而应该让HTTP库自己构造，参见下方的[代码示例](#上传图片代码示例)。</span>

#### 上传图片代码示例

##### Python (requests)

```python
import requests

url = "https://bbs.uestc.edu.cn/_/attachment/upload"

# 替换为你的实际 Cookie
cookies = {}

# 替换为你的实际 Authorization 令牌
headers = {"Authorization": "your_auth_token"}

# 注意：type 必须为 "image"
data = {
    "kind": "forum",
    "type": "image"
}

# 以二进制模式读取图片文件（支持 .jpg, .jpeg, .png 等）
with open("test.jpeg", "rb") as f:
    files = {
        "files[]": ("test.jpeg", f, "image/jpeg")  # MIME 类型匹配图片
    }
    response = requests.post(
        url,
        data=data,
        files=files,
        cookies=cookies,
        headers=headers
    )

print(response.json())
```

##### JavaScript (fetch)

```js
// 在浏览器中运行
// 假设你有一个 <input type="file" id="fileInput"> 用于选择图片
const fileInput = document.getElementById('fileInput');
const file = fileInput.files[0]; // 用户选择的图片文件

if (!file) {
    console.error("请先选择一个图片文件");
    return;
}

const formData = new FormData();
formData.append("kind", "forum");
formData.append("type", "image"); // 设为 "image"
formData.append("files[]", file, file.name); // 浏览器自动设置正确的 MIME 类型

fetch("https://bbs.uestc.edu.cn/_/attachment/upload", {
    method: "POST",
    body: formData,
    credentials: "include", // 自动携带当前站点的 Cookie
    headers: {
        "Authorization": "your_auth_token"
        // ⚠️ 不要设置 Content-Type！让浏览器自动设置含 boundary 的值
    }
})
.then(res => res.json())
.then(data => console.log("上传成功:", data))
.catch(err => console.error("上传失败:", err));
```

#### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "uploaded": [{
            "attachment_id": 2687364,
            "dateline": 1765385797,
            "filename": "test.jpeg",
            "size": 148277,
            "path": "/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg?variant=original",
            "remote": 0,
            "is_image": 1,
            "width": 1000,
            "thumb": false,
            "thumbnail_url": "/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg",
            "raw_url": "/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg"
        }]
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

### 上传其他类型文件

<details>
    <summary>数据包</summary>

```text
POST /_/attachment/upload HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 394
Authorization: 有效Authorization
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryGUKIZ1Osvoiuqy4W

------WebKitFormBoundaryGUKIZ1Osvoiuqy4W
Content-Disposition: form-data; name="kind"

forum
------WebKitFormBoundaryGUKIZ1Osvoiuqy4W
Content-Disposition: form-data; name="type"

file
------WebKitFormBoundaryGUKIZ1Osvoiuqy4W
Content-Disposition: form-data; name="files[]"; filename="test.txt"
Content-Type: text/plain

文件数据

------WebKitFormBoundaryGUKIZ1Osvoiuqy4W--

```

</details>
<br>

方法：`POST`

路径：`/_/attachment/upload`

> [!CAUTION]
> <span style="color:red">再次警告：在任何时候，你都不应该手动构造原始的HTTP数据包，而应该让HTTP库自己构造，参见下方的[代码示例](#上传其他类型文件代码示例)。</span>

#### 上传其他类型文件代码示例

##### Python (requests)

```python
import requests

url = "https://bbs.uestc.edu.cn/_/attachment/upload"

# 替换为实际 Cookie 和 Authorization
cookies = {}
headers = {"Authorization": "your_auth_token"}

data = {
    "kind": "forum",
    "type": "file"
}

# 上传文件，以二进制读取
with open("test.txt", "rb") as f:
    files = {"files[]": ("test.txt", f, "text/plain")}
    response = requests.post(url, data=data, files=files, cookies=cookies, headers=headers)

print(response.json())
```

##### JavaScript (fetch)

```js
// 在浏览器中运行
const formData = new FormData();
formData.append("kind", "forum");
formData.append("type", "file");
formData.append("files[]", new File(["test\n测试文件"], "test.txt"), "test.txt");

fetch("https://bbs.uestc.edu.cn/_/attachment/upload", {
  method: "POST",
  body: formData,
  credentials: "include", // 自动携带 Cookie
  headers: {
    "Authorization": "your_auth_token"
    // 不要设置 Content-Type！让HTTP库自己设置
  }
})
.then(res => res.json())
.then(console.log);
```

#### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "uploaded": [{
            "attachment_id": 2687361,
            "dateline": 1765384751,
            "filename": "test.txt",
            "size": 18,
            "path": "/data/attachment/forum/202512/11/01eeo6_md6hvghbbmudxn9tsubiicyb.attach",
            "remote": 0,
            "is_image": 0,
            "width": 0,
            "thumb": false
        }]
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```
