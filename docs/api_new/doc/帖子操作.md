# 帖子操作

要使用此文档所示的接口，请先[登录](./登录.md)。

## 发帖

<details>
    <summary>数据包</summary>

```text
POST /_/thread/new HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 
Authorization: 
Content-Length: 125

{"attachments":[],"forum_id":1024,"type_id":1437,"subject":"thread title","message":"thread content\n","format":2,"usesig":1}
```

</details>
<br>

方法：`POST`

路径：`/_/thread/new`

负载：

```json
{
    "attachments": [{
        "attachment_id": 2687361,
        "dateline": 1765384751,
        "filename": "test.txt",
        "size": 18,
        "path": "/data/attachment/forum/202512/11/01eeo6_md6hvghbbmudxn9tsubiicyb.attach",
        "remote": 0,
        "is_image": 0,
        "width": 0,
        "thumb": false
    }, {
        "attachment_id": 2687364,
        "dateline": 1765385797,
        "filename": "test.jpeg",
        "size": 148277,
        "path": "/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg?variant=original",
        "remote": 0,
        "is_image": 1,
        "width": 1000,
        "thumb": false,
        "thumbnail_url": "/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg",
        "raw_url": "/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg"
    }],
    "forum_id": 25,
    "type_id": 315,
    "subject": "thread title",
    "poll": {
        "max_choices": 2,
        "visible": false,
        "show_voters": true,
        "expiration": 172800,
        "is_image": false,
        "options": [{
            "text": "option 1"
        }, {
            "text": "option 2"
        }, {
            "text": "option 3"
        }]
    },
    "reply_credit": {
        "credit_amount": 5,
        "credit_name": "水滴",
        "count": 10,
        "limit_per_user": 2,
        "probability": 70
    },
    "message": "thread content\n\n[test.txt](a:2687361)\n\n![test.jpeg](i:2687364)\n",
    "format": 2,
    "usesig": 1
}
```

说明：

- `attachments`: 附件列表
- `forum_id`: 版块tid
- `type_id`: 帖子类型id
- `subject`: 帖子标题
- `message`: 帖子内容
- `format`: 帖子格式。从新版河畔发帖，此值为2
- `usesig`: 是否使用签名
- `poll`: 投票信息，非投票帖不要填写此字段
  - `max_choices`: 最多可选项数
  - `visible`: 是否可见
  - `show_voters`: 是否公开投票人
  - `expiration`: 投票有效期，单位秒
  - `is_image`: 是否图片投票，由于不确定是否有bug，建议设为false
  - `options`: 投票选项
- `reply_credit`: 回帖奖励，非散水帖不要填写此字段
  - `credit_amount`: 每次回帖奖励
  - `credit_name`: 请设为"水滴"
  - `count`: 总计份数
  - `limit_per_user`: 每人最多几次
  - `probability`: 中奖概率

获取指定版块的分类与`type_id`，参见[获取版块的分类及父版块](./版块详情.md#获取版块的分类及父版块)

附件列表格式如上，附件信息来自[上传附件](./附件.md#上传附件)的响应。

上传附件请参考[上传附件](./附件.md#上传附件)。

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "thread_id": 2413300,
        "ext_credits_update": {
            "水滴": -65
        }
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

`ext_credits_update`只有在发散水贴时才有。

## 回复

<details>
    <summary>数据包</summary>

```text
POST /_/thread/reply HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 
Authorization: 
Content-Length: 116

{"thread_id":2413262,"message":"test\n\nreply content\n","usesig":1,"is_anonymous":true,"attachments":[],"format":2}
```

</details>
<br>

方法：`POST`

路径：`/_/thread/reply`

负载：

```json
{
    "thread_id": 2413262,
    "message": "test\n\nreply content\n",
    "usesig": 1,
    "is_anonymous": true,
    "attachments": [],
    "format": 2
}
```

说明：

- `thread_id`: 帖子tid
- `message`: 帖子内容
- `usesig`: 是否使用签名，如果选了匿名发帖，不显示签名
- `is_anonymous`: 是否匿名，仅对密语区有效
- `attachments`: 附件列表
- `format`: 帖子格式。从新版河畔发帖，此值为2

附件列表格式参考[发帖](#发帖)中的附件列表格式，附件信息来自[上传附件](./附件.md#上传附件)的响应。

上传附件请参考[上传附件](./附件.md#上传附件)。

### 成功

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "post_id": 41377863
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

## 编辑主题帖

<details>
    <summary>数据包</summary>

```text
POST /_/post/edit HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 1473
Authorization: 有效Authorization

{"thread_id":2413300,"post_id":41378080,"subject":"thread title","message":"thread content\n\n[test.txt](a:2687361)\n\n![test.jpeg](i:2687364)\n","format":2,"smileyoff":0,"usesig":1,"is_anonymous":false,"type_id":315,"poll":{"show_voters":true,"multiple":true,"visible":false,"max_choices":2,"is_image":false,"expiration":1765560085,"voter_count":0,"options":[{"id":149925,"display_order":0,"text":"option 1"},{"id":149926,"display_order":0,"text":"option 2"},{"id":149927,"display_order":0,"text":"option 3"}]},"attachments":[{"attachment_id":2687361,"dateline":1765384751,"filename":"test.txt","size":18,"path":"/data/attachment/forum/202512/11/01eeo6_md6hvghbbmudxn9tsubiicyb.attach","description":"","price":0,"is_image":0,"width":0,"thumb":false,"picid":0,"download_url":"/_/attachment/forum/2687361?v=2687361%401765388231460%2F287813%3A51xtANr4UYAukZci-A9GMRQ-RAA9RNMTOkLGKJAi7wg"},{"attachment_id":2687364,"dateline":1765385797,"filename":"test.jpeg","size":148277,"path":"/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg?variant=original","description":"","price":0,"is_image":1,"width":1000,"thumb":false,"picid":0,"download_url":"/_/attachment/forum/2687364?v=2687364%401765388231460%2F287813%3AS_Bm1_mBWbW-6l-nsuDhK70H12Tb5gAom12LsiTQimA","thumbnail_url":"/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg","raw_url":"/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg"}],"editingThread":true}
```

</details>
<br>

方法：`POST`

路径：`/_/post/edit`

负载：

```json
{
    "thread_id": 2413300,
    "post_id": 41378080,
    "subject": "thread title",
    "message": "thread content\n\n[test.txt](a:2687361)\n\n![test.jpeg](i:2687364)\n",
    "format": 2,
    "smileyoff": 0,
    "usesig": 1,
    "is_anonymous": false,
    "type_id": 315,
    "poll": {
        "show_voters": true,
        "multiple": true,
        "visible": false,
        "max_choices": 2,
        "is_image": false,
        "expiration": 1765560085,
        "voter_count": 0,
        "options": [{
            "id": 149925,
            "display_order": 0,
            "text": "option 1"
        }, {
            "id": 149926,
            "display_order": 0,
            "text": "option 2"
        }, {
            "id": 149927,
            "display_order": 0,
            "text": "option 3"
        }]
    },
    "attachments": [{
        "attachment_id": 2687361,
        "dateline": 1765384751,
        "filename": "test.txt",
        "size": 18,
        "path": "/data/attachment/forum/202512/11/01eeo6_md6hvghbbmudxn9tsubiicyb.attach",
        "description": "",
        "price": 0,
        "is_image": 0,
        "width": 0,
        "thumb": false,
        "picid": 0,
        "download_url": "/_/attachment/forum/2687361?v=2687361%401765388231460%2F287813%3A51xtANr4UYAukZci-A9GMRQ-RAA9RNMTOkLGKJAi7wg"
    }, {
        "attachment_id": 2687364,
        "dateline": 1765385797,
        "filename": "test.jpeg",
        "size": 148277,
        "path": "/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg?variant=original",
        "description": "",
        "price": 0,
        "is_image": 1,
        "width": 1000,
        "thumb": false,
        "picid": 0,
        "download_url": "/_/attachment/forum/2687364?v=2687364%401765388231460%2F287813%3AS_Bm1_mBWbW-6l-nsuDhK70H12Tb5gAom12LsiTQimA",
        "thumbnail_url": "/thumb/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg",
        "raw_url": "/data/attachment/forum/202512/11/020t95_ce0x54j8d0pnd6o4lsu5yavm.jpg"
    }],
    "editingThread": true
}
```

说明：编辑可以被认为是用原pid重新再发一次，因此格式与[发帖](./帖子操作.md#发帖)完全一致，因此，你必须把附件、投票等信息也带上，散水信息不用带。此外额外有如下字段：

- `thread_id`: 帖子tid
- `post_id`: 帖子pid
- `editingThread`: 是否是编辑主题帖，此处为true

### 成功

```json
{
    "code": 0,
    "message": "success",
    "data": 46521,
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

这里的`data`为`edit_id`，若有，会在[获取帖子回复](./帖子详情.md#获取帖子回复)时返回。

## 编辑回复

<details>
    <summary>数据包</summary>

```text
POST /_/post/edit HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 168
Authorization: 有效Authorization

{"thread_id":2413300,"post_id":41378081,"subject":"","message":"test\n","format":2,"smileyoff":0,"usesig":1,"is_anonymous":false,"attachments":[],"editingThread":false}
```

</details>
<br>

方法：`POST`

路径：`/_/post/edit`

负载：

```json
{
    "thread_id": 2413300,
    "post_id": 41378081,
    "subject": "",
    "message": "test\n",
    "format": 2,
    "smileyoff": 0,
    "usesig": 1,
    "is_anonymous": false,
    "attachments": [],
    "editingThread": false
}
```

说明：编辑可以被认为是用原pid重新再发一次，因此格式与[回复](./帖子操作.md#回复)完全一致，因此，你必须把附件等信息也带上。此外额外有如下字段：

- `thread_id`: 回复所在的帖子tid
- `post_id`: 本条回复的pid
- `subject`: 标题。是的，你可以让回复也有标题
- `editingThread`: 是否编辑主题帖，此处为false

### 成功

```json
{
    "code": 0,
    "message": "success",
    "data": 46520,
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

这里的`data`为`edit_id`，若有，会在[获取帖子回复](./帖子详情.md#获取帖子回复)时返回。

## 点赞点踩与取消点赞取消点踩

<details>
    <summary>数据包</summary>

```text
POST /_/post/review?tid=2413255&pid=41377755&support=true HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Authorization: 有效Authorization
```

</details>
<br>

方法：`POST`

路径：`/_/post/review`

参数：

- `tid`: 帖子tid
- `pid`: 帖子或回复的pid，如果对主题帖点赞，此参数可省略
- `support`: true为点赞，false为点踩

说明：发包进行点赞/点踩，再次发送取消点赞/点踩。可从返回的data部分得知本次操作是点赞/点踩还是取消点赞/取消点踩。

### 点赞或点踩成功

```json
{
    "code": 0,
    "message": "success",
    "data": 0,
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

### 取消点赞或取消点踩成功

```json
{
    "code": 0,
    "message": "success",
    "data": 1,
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

### 失败

```json
{
    "code": 1019,
    "message": "抱歉，您不能评价自己的帖子",
    "data": null,
    "system": {}
}
```

## 点评

<details>
    <summary>数据包</summary>

```text
POST /_/post/comment HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Authorization: 有效Authorization
Content-Length: 68

{"thread_id":2412873,"post_id":41374524,"message":"comment message"}
```

</details>
<br>

方法：`POST`

路径：`/_/post/comment`

负载：

```json
{
    "thread_id": 2412873,
    "post_id": 41374524,
    "message": "comment message"
}
```

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": true,
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

## 获取评分面板信息

这些信息包括当前账户允许的最大最小评分值、今日剩余可评分数、税率、快捷评分短语等信息。

<details>
    <summary>数据包</summary>
```text
GET /_/post/41374524/rate HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Authorization: 有效Authorization
```
</details>
<br>

方法：`GET`

可变路径：`/_/post/{pid}/rate`

### 成功

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "require_notify": true,
        "credits": {
            "水滴": {
                "max": 50,
                "min": -5,
                "deduct_self": true,
                "limit_24h_positive": 400,
                "remaining_24h_positive": 400,
                "limit_24h_negative": 20,
                "remaining_24h_negative": 20,
                "tax_rate_negative": 1.15
            }
        },
        "common_reasons": ["很给力！", "谢谢分享。", "原创精品", "赞一个！", "淡定", "福！", "--------", "不福！", "差评！"]
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

### 失败

```json
{
    "code": 1016,
    "message": "您不能给自己的帖子评分。",
    "data": null,
    "system": {}
}
```

常见失败原因：

- 您不能给自己的帖子评分。
- 本帖发表时间较早，不再接受评分。
- 您已经为本帖评分，不可重复评分。

## 评分

<details>
    <summary>数据包</summary>

```text
POST /_/post/41373980/rate HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Authorization: 有效Authorization
Content-Length: 61

{"credits":{"水滴":1},"reason":"rate reason","notify":true}
```

</details>
<br>

方法：`POST`

可变路径：`/_/post/{pid}/rate`

负载：

```json
{
    "credits": {
        "水滴": 1
    },
    "reason": "rate reason",
    "notify": true
}
```

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "ext_credits_update": {
            "水滴": 1
        }
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

失败的响应与[获取评分面板信息](#获取评分面板信息)中的失败响应一致。

## 投票

<details>
    <summary>数据包</summary>

```text
POST /_/thread/poll/vote HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 47
Authorization: 有效Authorization

{"thread_id":2413300,"options":[149925,149926]}
```

</details>
<br>

方法：`POST`

路径：`/_/thread/poll/vote`

负载：

```json
{
    "thread_id": 2413300,
    "options": [149925, 149926]
}
```

说明：

- `thread_id`: 投票帖子tid
- `options`: 投票选项的id，数组表示

选项文本与选项id的对应关系，请参考[在获取回复时获取其余信息](./帖子详情.md#在获取回复时获取其余信息)时的响应中的`thread`中的`pool`部分。

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "show_voters": true,
        "multiple": true,
        "visible": false,
        "max_choices": 2,
        "is_image": false,
        "expiration": 1765560085,
        "voter_count": 1,
        "options": [{
            "id": 149925,
            "votes": 1,
            "display_order": 0,
            "text": "option 1",
            "voters": [287813]
        }, {
            "id": 149926,
            "votes": 1,
            "display_order": 0,
            "text": "option 2",
            "voters": [287813]
        }, {
            "id": 149927,
            "votes": 0,
            "display_order": 0,
            "text": "option 3"
        }],
        "selected_options": [149925, 149926]
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

## 获取收藏情况

<details>
    <summary>数据包</summary>

```text
GET /_/thread/2234791/favorite HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Authorization: 有效Authorization
```

</details>
<br>

方法：`GET`

可变路径：`/_/thread/{tid}/favorite`

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "is_personal_favorite": true,
        "public_favorites": [{
            "collection_id": 1130,
            "owner_uid": 287813,
            "username": "Range6",
            "name": "test",
            "description": "测试用",
            "is_owner": true,
            "is_favorite":true
        }]
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

- `is_personal_favorite`: 是否为个人收藏，如果你没收藏则直接没有这个字段
- `public_favorites`: 淘专辑，如果你没有淘专辑则直接没有这个字段
  - `is_favorite`: 是否已收录，若为收录则直接没有这个字段

## 将贴子添加到个人收藏或淘专辑

<details>
    <summary>数据包</summary>

```text
PUT /_/thread/2234791/favorite HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 49
Authorization: 有效Authorization

{"personal_favorite":false,"collection_id":1130}
```

</details>
<br>

方法：`PUT`

可变路径：`/_/thread/{tid}/favorite`

负载：

```json
{
    "personal_favorite":false,
    "collection_id":1130
}
```

说明：添加到个人收藏时，`personal_favorite`为`true`，添加到淘专辑时，`collection_id`为专辑id。淘专辑的id，请从[获取收藏情况](#获取收藏情况)的返回结果中获取。

注意：从实际运行结果来看，一个请求同时只能处理一个项目。若`personal_favorite`为`true`，服务器会直接忽略`collection_id`。`collection_id`只能为一个数字。所以，添加到个人收藏应单独发包，每个淘专辑应单独发包。

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {},
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

## 将贴子从个人收藏或淘专辑删除

<details>
    <summary>数据包</summary>

```text
POST /_/user/favorites/delete HTTP/1.1
Host: bbs.uestc.edu.cn
Cookie: 有效Cookie
Content-Length: 69
Authorization: 有效Authorization

{"personal_favorite":false,"collection_id":1130,"tid_list":[2234791]}
```

</details>
<br>

方法：`POST`

路径：`/_/user/favorites/delete`

负载：

```json
{
    "personal_favorite": false,
    "collection_id": 1130,
    "tid_list": [2234791]
}
```

### 响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "deleted_count": 1
    },
    "user": {
        "uid": 287813,
        "username": "Range6",
        "new_pm_legacy": false,
        "new_notification": 0,
        "new_pm": 0,
        "new_grouppm_legacy": false,
        "settings_version": 0
    },
    "system": {
        "settings_version": 11,
        "client_version": 1
    }
}
```

说明：从个人收藏删除时，`personal_favorite`为`true`，从淘专辑删除时，`collection_id`为专辑id。淘专辑的id，请从[获取收藏情况](#获取收藏情况)的返回结果中获取。

注意：从实际运行结果来看，一个请求同时只能处理一个项目。若`personal_favorite`为`true`，服务器会直接忽略`collection_id`。`collection_id`只能为一个数字。所以，从个人收藏删除应单独发包，每个淘专辑应单独发包。
